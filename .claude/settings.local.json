{
  "permissions": {
    "allow": [
      "Bash(dir:*)",
      "Bash(dotnet build:*)",
      "Bash(pwsh:*)",
      "Bash(powershell.exe -ExecutionPolicy Bypass -File /tmp/fix_results.ps1)",
      "Bash(dotnet add:*)",
      "Bash(copy:*)",
      "Bash(ls -la \"e:\\\\QLTS\\\\backend\\\\src\\\\Authorization\"\" 2>/dev/null || find e:/QLTS/backend/src/Authorization -type f -name \"*.cs \")",
      "Bash(dotnet tool install:*)",
      "Bash(dotnet ef migrations add:*)",
      "Bash(npm install)",
      "Bash(npx nx serve:*)",
      "Bash(npx nx build:*)",
      "Bash(npx tsc:*)",
      "Bash(npm install:*)",
      "Bash(npm run build:*)",
      "Bash(netstat:*)",
      "Bash(findstr:*)",
      "Bash(taskkill:*)",
      "Bash(tasklist:*)",
      "Bash(/e/QLTS/backend/src/Identity/Features/ForgotPassword/ForgotPasswordCommand.cs << 'EOF'\nusing BuildingBlocks.Common.Abstractions;\n\nnamespace Identity.Features.ForgotPassword;\n\npublic record ForgotPasswordCommand\\(string Email\\) : ICommand<ForgotPasswordResponse>;\n\npublic record ForgotPasswordResponse\\(string Message\\);\nEOF)",
      "Bash(/e/QLTS/backend/src/Identity/Features/ForgotPassword/ForgotPasswordCommandHandler.cs << 'EOF'\nusing System.Security.Cryptography;\nusing BuildingBlocks.Common.Abstractions;\nusing BuildingBlocks.Common.Results;\nusing BuildingBlocks.Database;\nusing Identity.Entities;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Configuration;\n\nnamespace Identity.Features.ForgotPassword;\n\npublic class ForgotPasswordCommandHandler : ICommandHandler<ForgotPasswordCommand, ForgotPasswordResponse>\n{\n    private readonly ApplicationDbContext _context;\n    private readonly IConfiguration _configuration;\n\n    public ForgotPasswordCommandHandler\\(\n        ApplicationDbContext context,\n        IConfiguration _configuration\\)\n    {\n        _context = context;\n        this._configuration = _configuration;\n    }\n\n    public async Task<Result<ForgotPasswordResponse>> Handle\\(\n        ForgotPasswordCommand request,\n        CancellationToken cancellationToken\\)\n    {\n        var user = await _context.Set<User>\\(\\)\n            .FirstOrDefaultAsync\\(u => u.Email == request.Email, cancellationToken\\);\n\n        // Always return success to prevent email enumeration\n        if \\(user == null\\)\n        {\n            return Result.Success\\(new ForgotPasswordResponse\\(\n                \"If an account with that email exists, a password reset link has been sent.\"\\)\\);\n        }\n\n        // Generate reset token\n        var resetToken = GenerateResetToken\\(\\);\n        var hashedToken = BCrypt.Net.BCrypt.HashPassword\\(resetToken\\);\n\n        var expirationMinutes = Convert.ToInt32\\(_configuration[\"PasswordReset:ExpirationMinutes\"] ?? \"60\"\\);\n        var resetTokenEntity = new PasswordResetToken\n        {\n            UserId = user.Id,\n            Token = hashedToken,\n            ExpiresAt = DateTime.UtcNow.AddMinutes\\(expirationMinutes\\)\n        };\n\n        _context.Set<PasswordResetToken>\\(\\).Add\\(resetTokenEntity\\);\n        await _context.SaveChangesAsync\\(cancellationToken\\);\n\n        // TODO: Send email with reset link\n        // var resetLink = $\"{_configuration[\"App:FrontendUrl\"]}/reset-password?token={resetToken}&email={user.Email}\";\n        // await _emailService.SendPasswordResetEmailAsync\\(user.Email, user.FullName, resetLink\\);\n\n        // For now, log the token \\(remove in production\\)\n        Console.WriteLine\\($\"Password Reset Token for {user.Email}: {resetToken}\"\\);\n        Console.WriteLine\\($\"Token ID: {resetTokenEntity.Id}\"\\);\n\n        return Result.Success\\(new ForgotPasswordResponse\\(\n            \"If an account with that email exists, a password reset link has been sent.\"\\)\\);\n    }\n\n    private static string GenerateResetToken\\(\\)\n    {\n        var randomBytes = new byte[32];\n        using var rng = RandomNumberGenerator.Create\\(\\);\n        rng.GetBytes\\(randomBytes\\);\n        return Convert.ToBase64String\\(randomBytes\\).Replace\\(\"+\", \"-\"\\).Replace\\(\"/\", \"_\"\\).TrimEnd\\('='\\);\n    }\n}\nEOF)",
      "Bash(/e/QLTS/backend/src/Identity/Features/ResetPassword/ResetPasswordCommand.cs << 'EOF'\nusing BuildingBlocks.Common.Abstractions;\n\nnamespace Identity.Features.ResetPassword;\n\npublic record ResetPasswordCommand\\(\n    string Email,\n    string Token,\n    string NewPassword\n\\) : ICommand<ResetPasswordResponse>;\n\npublic record ResetPasswordResponse\\(string Message\\);\nEOF)",
      "Bash(/e/QLTS/backend/src/Identity/Features/ResetPassword/ResetPasswordCommandHandler.cs << 'EOF'\nusing BuildingBlocks.Common.Abstractions;\nusing BuildingBlocks.Common.Results;\nusing BuildingBlocks.Database;\nusing Identity.Entities;\nusing Microsoft.EntityFrameworkCore;\n\nnamespace Identity.Features.ResetPassword;\n\npublic class ResetPasswordCommandHandler : ICommandHandler<ResetPasswordCommand, ResetPasswordResponse>\n{\n    private readonly ApplicationDbContext _context;\n\n    public ResetPasswordCommandHandler\\(ApplicationDbContext context\\)\n    {\n        _context = context;\n    }\n\n    public async Task<Result<ResetPasswordResponse>> Handle\\(\n        ResetPasswordCommand request,\n        CancellationToken cancellationToken\\)\n    {\n        var user = await _context.Set<User>\\(\\)\n            .FirstOrDefaultAsync\\(u => u.Email == request.Email, cancellationToken\\);\n\n        if \\(user == null\\)\n        {\n            return Result.Failure<ResetPasswordResponse>\\(\"Invalid reset token\"\\);\n        }\n\n        // Find valid reset token\n        var resetToken = await _context.Set<PasswordResetToken>\\(\\)\n            .Where\\(t => t.UserId == user.Id\n                && !t.IsUsed\n                && t.ExpiresAt > DateTime.UtcNow\\)\n            .OrderByDescending\\(t => t.CreatedAt\\)\n            .FirstOrDefaultAsync\\(cancellationToken\\);\n\n        if \\(resetToken == null\\)\n        {\n            return Result.Failure<ResetPasswordResponse>\\(\"Invalid or expired reset token\"\\);\n        }\n\n        // Verify token\n        if \\(!BCrypt.Net.BCrypt.Verify\\(request.Token, resetToken.Token\\)\\)\n        {\n            return Result.Failure<ResetPasswordResponse>\\(\"Invalid reset token\"\\);\n        }\n\n        // Update password\n        user.PasswordHash = BCrypt.Net.BCrypt.HashPassword\\(request.NewPassword\\);\n\n        // Mark token as used\n        resetToken.IsUsed = true;\n        resetToken.UsedAt = DateTime.UtcNow;\n\n        // Invalidate all refresh tokens for security\n        var refreshTokens = await _context.Set<RefreshToken>\\(\\)\n            .Where\\(rt => rt.UserId == user.Id && !rt.IsRevoked\\)\n            .ToListAsync\\(cancellationToken\\);\n\n        foreach \\(var rt in refreshTokens\\)\n        {\n            rt.RevokedAt = DateTime.UtcNow;\n        }\n\n        await _context.SaveChangesAsync\\(cancellationToken\\);\n\n        return Result.Success\\(new ResetPasswordResponse\\(\"Password has been reset successfully\"\\)\\);\n    }\n}\nEOF)",
      "Bash(/e/QLTS/backend/src/Identity/Features/ResetPassword/ResetPasswordValidator.cs << 'EOF'\nusing FluentValidation;\n\nnamespace Identity.Features.ResetPassword;\n\npublic class ResetPasswordValidator : AbstractValidator<ResetPasswordCommand>\n{\n    public ResetPasswordValidator\\(\\)\n    {\n        RuleFor\\(x => x.Email\\)\n            .NotEmpty\\(\\).WithMessage\\(\"Email is required\"\\)\n            .EmailAddress\\(\\).WithMessage\\(\"Invalid email format\"\\);\n\n        RuleFor\\(x => x.Token\\)\n            .NotEmpty\\(\\).WithMessage\\(\"Reset token is required\"\\);\n\n        RuleFor\\(x => x.NewPassword\\)\n            .NotEmpty\\(\\).WithMessage\\(\"New password is required\"\\)\n            .MinimumLength\\(6\\).WithMessage\\(\"Password must be at least 6 characters\"\\)\n            .Matches\\(@\"[A-Z]\"\\).WithMessage\\(\"Password must contain at least one uppercase letter\"\\)\n            .Matches\\(@\"[a-z]\"\\).WithMessage\\(\"Password must contain at least one lowercase letter\"\\)\n            .Matches\\(@\"[0-9]\"\\).WithMessage\\(\"Password must contain at least one number\"\\)\n            .Matches\\(@\"[@$!%*?&#]\"\\).WithMessage\\(\"Password must contain at least one special character\"\\);\n    }\n}\nEOF)",
      "Bash(/e/QLTS/backend/src/Identity/Services/EmailService.cs << 'EOF'\nusing System.Net;\nusing System.Net.Mail;\nusing Microsoft.Extensions.Configuration;\nusing Microsoft.Extensions.Logging;\n\nnamespace Identity.Services;\n\npublic class EmailService : IEmailService\n{\n    private readonly IConfiguration _configuration;\n    private readonly ILogger<EmailService> _logger;\n\n    public EmailService\\(IConfiguration configuration, ILogger<EmailService> logger\\)\n    {\n        _configuration = configuration;\n        _logger = logger;\n    }\n\n    public async Task SendPasswordResetEmailAsync\\(\n        string toEmail,\n        string userName,\n        string resetLink,\n        CancellationToken cancellationToken = default\\)\n    {\n        var subject = \"Password Reset Request\";\n        var body = $@\"\n<!DOCTYPE html>\n<html>\n<head>\n    <style>\n        body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}\n        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n        .header {{ background-color: #4CAF50; color: white; padding: 20px; text-align: center; }}\n        .content {{ padding: 20px; background-color: #f9f9f9; }}\n        .button {{ display: inline-block; padding: 12px 24px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 4px; margin: 20px 0; }}\n        .footer {{ text-align: center; padding: 20px; font-size: 12px; color: #666; }}\n    </style>\n</head>\n<body>\n    <div class='container'>\n        <div class='header'>\n            <h1>Password Reset Request</h1>\n        </div>\n        <div class='content'>\n            <p>Hello {userName},</p>\n            <p>We received a request to reset your password. Click the button below to reset it:</p>\n            <p style='text-align: center;'>\n                <a href='{resetLink}' class='button'>Reset Password</a>\n            </p>\n            <p>Or copy and paste this link into your browser:</p>\n            <p><a href='{resetLink}'>{resetLink}</a></p>\n            <p><strong>This link will expire in 60 minutes.</strong></p>\n            <p>If you didn't request a password reset, please ignore this email.</p>\n        </div>\n        <div class='footer'>\n            <p>Â© 2025 Asset Management System. All rights reserved.</p>\n        </div>\n    </div>\n</body>\n</html>\";\n\n        await SendEmailAsync\\(toEmail, subject, body, cancellationToken\\);\n    }\n\n    public async Task SendWelcomeEmailAsync\\(\n        string toEmail,\n        string userName,\n        CancellationToken cancellationToken = default\\)\n    {\n        var subject = \"Welcome to Asset Management System\";\n        var body = $@\"\n<!DOCTYPE html>\n<html>\n<body>\n    <h2>Welcome {userName}!</h2>\n    <p>Thank you for joining our Asset Management System.</p>\n    <p>You can now log in and start managing your assets.</p>\n</body>\n</html>\";\n\n        await SendEmailAsync\\(toEmail, subject, body, cancellationToken\\);\n    }\n\n    public async Task SendEmailVerificationAsync\\(\n        string toEmail,\n        string userName,\n        string verificationLink,\n        CancellationToken cancellationToken = default\\)\n    {\n        var subject = \"Email Verification\";\n        var body = $@\"\n<!DOCTYPE html>\n<html>\n<body>\n    <h2>Verify Your Email</h2>\n    <p>Hello {userName},</p>\n    <p>Please click the link below to verify your email address:</p>\n    <p><a href='{verificationLink}'>Verify Email</a></p>\n</body>\n</html>\";\n\n        await SendEmailAsync\\(toEmail, subject, body, cancellationToken\\);\n    }\n\n    private async Task SendEmailAsync\\(\n        string toEmail,\n        string subject,\n        string body,\n        CancellationToken cancellationToken = default\\)\n    {\n        try\n        {\n            var smtpHost = _configuration[\"Email:SmtpHost\"] ?? \"smtp.gmail.com\";\n            var smtpPort = Convert.ToInt32\\(_configuration[\"Email:SmtpPort\"] ?? \"587\"\\);\n            var fromEmail = _configuration[\"Email:FromEmail\"];\n            var fromName = _configuration[\"Email:FromName\"] ?? \"Asset Management System\";\n            var username = _configuration[\"Email:Username\"];\n            var password = _configuration[\"Email:Password\"];\n\n            if \\(string.IsNullOrEmpty\\(fromEmail\\) || string.IsNullOrEmpty\\(username\\) || string.IsNullOrEmpty\\(password\\)\\)\n            {\n                _logger.LogWarning\\(\"Email configuration is missing. Email not sent to {Email}\", toEmail\\);\n                Console.WriteLine\\($\"[EMAIL] Would send to {toEmail}: {subject}\"\\);\n                return;\n            }\n\n            using var client = new SmtpClient\\(smtpHost, smtpPort\\)\n            {\n                EnableSsl = true,\n                Credentials = new NetworkCredential\\(username, password\\)\n            };\n\n            var mailMessage = new MailMessage\n            {\n                From = new MailAddress\\(fromEmail, fromName\\),\n                Subject = subject,\n                Body = body,\n                IsBodyHtml = true\n            };\n\n            mailMessage.To.Add\\(toEmail\\);\n\n            await client.SendMailAsync\\(mailMessage, cancellationToken\\);\n\n            _logger.LogInformation\\(\"Email sent successfully to {Email}\", toEmail\\);\n        }\n        catch \\(Exception ex\\)\n        {\n            _logger.LogError\\(ex, \"Failed to send email to {Email}\", toEmail\\);\n            throw;\n        }\n    }\n}\nEOF)",
      "Bash(/tmp/hashgen.cs << 'EOF'\nusing System;\n\nclass Program\n{\n    static void Main\\(\\)\n    {\n        string password = \"Admin@123\";\n        string hash = BCrypt.Net.BCrypt.HashPassword\\(password, 11\\);\n        \n        Console.WriteLine\\(\"Password: \" + password\\);\n        Console.WriteLine\\(\"BCrypt Hash: \" + hash\\);\n        Console.WriteLine\\(\\);\n        Console.WriteLine\\(\"Verify test: \" + BCrypt.Net.BCrypt.Verify\\(password, hash\\)\\);\n    }\n}\nEOF)",
      "Bash(dotnet script eval:*)",
      "Bash(dotnet run:*)",
      "Bash(curl:*)",
      "Bash(dotnet remove reference:*)",
      "Bash(find:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git remote add:*)",
      "Bash(git push:*)",
      "WebFetch(domain:adminlte.io)"
    ]
  }
}
